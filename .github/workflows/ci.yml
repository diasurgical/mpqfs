name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        compiler: [gcc, clang]
        build_type: [Debug, Release]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y zlib1g-dev

      - name: Set compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> "$GITHUB_ENV"
          else
            echo "CC=clang" >> "$GITHUB_ENV"
          fi

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Unit tests
        run: ./build/mpqfs_test

      - name: Download spawn.mpq
        run: wget -qnc https://github.com/diasurgical/devilutionx-assets/releases/download/v2/spawn.mpq -P build

      - name: Integration test - archive opens
        run: ./build/mpqfs_test build/spawn.mpq 2>&1 | grep -q "Archive opened successfully"

      - name: Integration test - extract PCX
        run: |
          ./build/mpqfs_test build/spawn.mpq 'ui_art\title.pcx' > build/title.pcx
          EXPECTED=80648
          ACTUAL=$(stat -c%s build/title.pcx)
          echo "Extracted title.pcx: $ACTUAL bytes (expected $EXPECTED)"
          if [ "$ACTUAL" -ne "$EXPECTED" ]; then
            echo "::error::Size mismatch: got $ACTUAL, expected $EXPECTED"
            exit 1
          fi
          # Verify PCX magic byte
          MAGIC=$(xxd -l1 -p build/title.pcx)
          if [ "$MAGIC" != "0a" ]; then
            echo "::error::Bad PCX magic: got 0x$MAGIC, expected 0x0a"
            exit 1
          fi